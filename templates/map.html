<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:regular">
    <style>
        * {
            font-family: "Montserrat", sans-serif
        }
        input {
            width: 40%;
            position: absolute;
            right: 10px;
        }
        .collapsible {
            background-color: #0074d9;
            color: white;
            cursor: pointer;
            padding: 0 20px;
            width: 100%;
            height: 50px;
            line-height: 50px;
            font-size: 14.4pt;
            font-weight: bold;
            outline: none;
            border: none;
        }

        .activeCollapsible, .collapsible:hover {
            background-color: #0076fb;
        }

        .info {
            padding: 0 18px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            background-color: #f1f1f1;
            font-size: 10pt;
        }

        .transparent-div-icon {
            background-color: transparent;
            outline: transparent;
        }
    </style>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/universal.css') }}"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='sidebar-v2/css/leaflet-sidebar.css') }}"/>
    <script src="{{ url_for('static', filename='sidebar-v2/js/leaflet-sidebar.js') }}"></script>
    <script src="https://unpkg.com/leaflet-responsive-popup@0.6.4/leaflet.responsive.popup.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-responsive-popup@0.6.4/leaflet.responsive.popup.css" />
    <title>{{map_name}} Map</title>
</head>
<body>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#mass-outbreak" role="tab"><i class="fa fa-bug"></i></a></li>
                <li><a href="#battle" role="tab"><i class="icon-pokeball"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    PLA-Live-Map
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1><br>
                <button onclick="window.location.href='../'">Pick Another Map</button><br>
                <button onclick=updatePositions()>Update Active Spawns</button><br>
                <button onclick=checkNearShinies()>Check Near Shinies</button><br>
                <button onclick=trackPlayer() id="trackPlayerButton">Track Player Position</button><br>
                <button onclick=placeTeleport() id="placeTeleportButton">Teleport</button><br>
                <label for="y">Teleport Height:</label>
                <input type="number" id="y" value=50><br>
                <label for="rolls">Shiny Rolls:</label>
                <input type="number" id="rolls" value=1><br>
                <label for="thresh">Near Shiny Limit</label>
                <input type="number" id="thresh" value=50><br>
                <label for="initialSpawn">Initial Spawn</label>
                <input type="checkbox" id="initSpawn">
            </div>

            <div class="sidebar-pane" id="mass-outbreak">
                <h1 class="sidebar-header">
                    Mass Outbreak Information
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1><br>
                <label for="massOutbreakRolls">Shiny Rolls:</label>
                <input type="number" id="massOutbreakRolls" value=26><br>
                <label for="aggressivePath">Aggressive Shiny Pathfinding</label>
                <input type="checkbox" id="aggressivePath"><br>
                <label for="massOutbreakSpawns">Aggressive Total Spawns:</label>
                <input type="number" id="massOutbreakSpawns" value=10><br>
                <button onclick=loadMassOutbreakInfo()>Update Mass Outbreak Info</button><br><br>
                <button type="button" class="collapsible" data-for="currentMassOutbreak">Current Mass Outbreak</button>
                <div class="info" id="currentMassOutbreak">
                    <b>No info present</b>
                </div><br>
                <button type="button" class="collapsible" data-for="shinyMassOutbreak">Next Shiny Mass Outbreak</button>
                <div class="info" id="shinyMassOutbreak">
                    <b>No info present</b>
                </div>
            </div>

            <div class="sidebar-pane" id="battle">
                <h1 class="sidebar-header">
                    Battle Information
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1><br>
                <button onclick=loadBattleInfo()>Update Battle Info</button><br><br>
                <div id="battleInfo"></div>
            </div>
        </div>
    </div>
    <div id="map" class="sidebar-map"></div>
    <script src="{{ url_for('static', filename='js/universal.js') }}"></script>
    <script>
        let coordinates = {};
        let markerObjs = {};
        let popupCoordinates = [0,0,0];
        let teleporting = false;
        let tracking = false;
        let player_marker;
        let positionUpdater;
        let customMarkers = JSON.parse("{{custom_markers}}".replaceAll("&#34;",'"'))
        let customMarkerNames = Object.keys(customMarkers);
        for (let i = 0; i < customMarkerNames.length; i++) {
            let name = customMarkerNames[i];
            let marker = customMarkers[name];
            let icon = L.divIcon({
                html: `<i class="fa fa-${marker['faIcon']} fa-2x" style="color:#dd4659"></i>`,
                iconSize: [ 32, 32 ],
                iconAnchor: [ 16, 16 ],
                className: "transparent-div-icon"
            });
            L.marker(convertCoords(marker.coords), { icon: icon }).addTo(map).bindPopup(L.responsivePopup().setContent(`<button data-coords=[${marker.coords}] onclick="teleport(JSON.parse(this.dataset.coords))">Teleport to ${name}</button>`));
        }
        function collapsibleOnClick() {
            console.log(this);
            let info = document.getElementById(this.dataset.for);
            this.classList.toggle("activeCollapsible")
            if (info.style.maxHeight) {
                info.style.maxHeight = null;
            }
            else {
                info.style.maxHeight = info.scrollHeight + "px";
            }
        }

        function updateCollapsibleOnClick() {
        let elements = document.getElementsByClassName("collapsible");
            for (let i = 0; i < elements.length; i++) {
                let element = elements[i];
                element.onclick = collapsibleOnClick;
            }
        }

        updateCollapsibleOnClick();

        map.on('click', function(e){
            if (teleporting) {
                let coords = e.latlng;
                teleport(revertCoordinates([coords['lat'], coords['lng']]));
                teleporting = false;
                document.getElementById("placeTeleportButton").textContent = "Teleport";
            }
        });
        L.tileLayer("https://www.serebii.net/pokearth/hisui/{{map_name}}/tile_{z}-{x}-{y}.png", {
            minZoom: 0,
            maxZoom: 2,
            noWrap: true,
            attribution: "Pok&eacute;mon Legends: Arceus",//map label in bottom right
        }).addTo(map);

        function convertCoords(coordinates) {
            return [coordinates[2] * -0.5, coordinates[0] * 0.5];
        }
        function revertCoordinates(coordinates) {
            return [coordinates[1] / 0.5, parseInt(document.getElementById("y").value), coordinates[0] / -0.5];
        }
        function updateCollapsibleSize(info, opposite = true) {
            if (opposite) {
                if (info.style.maxHeight) {
                    info.style.maxHeight = null;
                }
                else {
                    info.style.maxHeight = info.scrollHeight + "px";
                }
            }
            else {
                if (info.style.maxHeight) {
                    info.style.maxHeight = info.scrollHeight + "px";
                }
                else {
                    info.style.maxHeight = null;
                }
            }
        }
        function loadBattleInfo() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/read-battle", true);
            xhr.onload = parseInfo;
            function parseInfo()
            {
                document.getElementById("battleInfo").innerHTML = xhr.responseText;
                updateCollapsibleOnClick();
            }
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send();
        }
        function loadMassOutbreakInfo() {
            let currentMassOutbreakInfo = document.getElementById("currentMassOutbreak");
            let shinyMassOutbreakInfo = document.getElementById("shinyMassOutbreak");
            currentMassOutbreakInfo.innerHTML = "Loading...";
            shinyMassOutbreakInfo.innerHTML = "Loading...";
            updateCollapsibleSize(currentMassOutbreakInfo,false);
            updateCollapsibleSize(shinyMassOutbreakInfo,false);
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/read-mass-outbreak", true);
            xhr.onload = parseInfo;
            function parseInfo()
            {
                let display = JSON.parse(xhr.responseText);
                currentMassOutbreakInfo.innerHTML = display[0];
                shinyMassOutbreakInfo.innerHTML = display[1];
                updateCollapsibleSize(currentMassOutbreakInfo,false);
                updateCollapsibleSize(shinyMassOutbreakInfo,false);
            }
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                name: "{{map_name}}",
                rolls: parseInt(document.getElementById("massOutbreakRolls").value),
                aggressivePath: document.getElementById("aggressivePath").checked,
                aggressiveSpawns: parseInt(document.getElementById("massOutbreakSpawns").value)
            }));
        }
        function readPlayerCoords() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/read-coords", true);
            xhr.onload = parseInfo;
            function parseInfo()
            {
                let coords = JSON.parse(xhr.responseText);
                if (player_marker != null) {
                    player_marker.remove();
                }
                player_marker = L.marker(convertCoords([coords["x"], coords["y"], coords["z"]]), { riseOnHover: true, icon:  L.icon({ iconUrl: "{{ url_for('static', filename='resources/player.png') }}", iconSize: [ 32, 32 ], iconAnchor: [ 16, 16 ] })});
                player_marker.addTo(map);
            }
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send();
        }
        function teleport(coords) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/teleport", true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                coords: coords
            }));
        }
        function updatePositions(e) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/update-positions", true);
            xhr.onload = parseInfo;
            function parseInfo()
            {
                coordinates = {};
                let spawns = JSON.parse(xhr.responseText);
                let keys = Object.keys(spawns);
                for (let i = 0; i < keys.length; i++) {
                    let key = keys[i];
                    let item = spawns[key];
                    coordinates[i.toString()] = [item['x'],item['y'],item['z']];
                    let coords = convertCoords([item['x'],item['y'],item['z']])
                    L.marker(coords, { icon:  L.icon({ riseOnHover: true, iconUrl: "{{ url_for('static', filename='resources/pokemon.png') }}", iconSize: [ 32, 32 ], iconAnchor: [ 16, 16 ] }), groupID: parseInt(key), ivs: 0 }).addTo(map).bindPopup(L.responsivePopup().setContent(`<button onclick="teleport(coordinates[${i}])">Teleport to spawner id ${key}</button>`))
                    .on("click",popupOnClick);
                }
            }
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(null);
        }
        function popupOnClick(e) {
            popupCoordinates = e.sourceTarget.options.coords;
            if (e.sourceTarget.options.groupID != -1) {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/read-seed", true);
                xhr.onload = parseInfo;
                function parseInfo() {
                    var popup = e.target.getPopup();
                    popup.setContent( popup.getContent().split('<br>')[0] + '<br>' + xhr.responseText );
                }
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify({
                    groupID: e.sourceTarget.options.groupID,
                    ivs: e.sourceTarget.options.ivs,
                    rolls: parseInt(document.getElementById("rolls").value),
                    thresh: parseInt(document.getElementById("thresh").value),
                    initSpawn: document.getElementById("initSpawn").checked
                }));
            }
        }
        function checkNearShinies(e) {
            let keys = Object.keys(markerObjs);
            for (let i = 0; i < keys.length; i++) {
                let marker = markerObjs[keys[i]];
                marker.setIcon(L.icon({ iconUrl: marker.options.iconUrl, iconSize: [ 32, 32 ], iconAnchor: [ 16, 16 ] }));
            }
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/check-near", true);
            xhr.onload = parseInfo;
            function parseInfo() 
            {
                let near = JSON.parse(xhr.responseText);
                for (let i = 0; i < near.length; i++) {
                    let groupID = near[i];
                    let marker = markerObjs[groupID];
                    marker.setIcon(L.icon({ iconUrl: marker.options.iconUrl.slice(0,-4) + "-green.png", iconSize: [ 32, 32 ], iconAnchor: [ 16, 16 ] }));
                }
            }
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                name: "{{map_name}}",
                rolls: parseInt(document.getElementById("rolls").value),
                thresh: parseInt(document.getElementById("thresh").value),
                initSpawn: document.getElementById("initSpawn").checked
            }))             
        }
        function trackPlayer() {
            if (tracking) {
                player_marker.remove();
                clearInterval(positionUpdater);
                document.getElementById("trackPlayerButton").textContent = "Track Player Position";
                tracking = false;
            }
            else {
                positionUpdater = setInterval(readPlayerCoords,2500);
                document.getElementById("trackPlayerButton").textContent = "Stop Tracking";
                tracking = true;
            }
        }
        function placeTeleport() {
            if (teleporting) {
                teleporting = false;
                document.getElementById("placeTeleportButton").textContent = "Teleport";
            }
            else {
                teleporting = true;
                document.getElementById("placeTeleportButton").textContent = "Cancel Teleport";
            }
        }
        function teleportPopup() {
            teleport(popupCoordinates);
        }
        var sidebar = L.control.sidebar('sidebar').addTo(map);
        let iURL;
        let popupText;
        let markerObj;
        {% for marker in markers %}
        popupText = `<button onclick=teleportPopup()>Teleport to group id ${"{{marker.groupID}}"}</button>`;
        iURL = "{{ url_for('static', filename='resources') }}/" + "{{marker.icon}}".split("/")[4];
        markerObj = L.marker(convertCoords({{ marker.coords }}), { riseOnHover: true, icon: L.icon({ iconUrl: iURL, iconSize: [ 32, 32 ], iconAnchor: [ 16, 16 ] }), iconUrl: iURL, groupID: {{ marker.groupID }}, ivs: {{ marker.ivs }}, coords: {{ marker.coords }}})
        markerObj.addTo(map)
        .bindPopup(L.responsivePopup().setContent(popupText))
        .on("click",popupOnClick);
        markerObjs[{{ marker.groupID }}] = markerObj;
        {% endfor %}
    </script>
</body>
</html>